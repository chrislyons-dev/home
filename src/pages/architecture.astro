---
import Layout from '../layouts/Layout.astro';
import PlantUMLDiagram from '../components/PlantUMLDiagram';
import architectureMermaidUrl from '../scripts/architecture-mermaid.js?url';

// Import example diagrams at build time
import microservicesDiagram from '../../docs/architecture/examples/microservices.mmd?raw';
import dataPipelineDiagram from '../../docs/architecture/examples/data-pipeline.mmd?raw';
import orderServiceDiagram from '../../docs/architecture/examples/order-service.puml?raw';
---

<Layout
  title="Architecture â€” Chris Lyons"
  description="Architecture as code examples using Mermaid and PlantUML diagrams that live with the system."
>
  <div class="mx-auto max-w-6xl px-4 py-20 sm:px-6 lg:px-8">
    <h1 class="mb-4 text-4xl font-bold sm:text-5xl">Architecture as Code</h1>
    <p class="mb-12 text-xl text-gray-600 dark:text-slate-400">
      Living documentation that evolves with your systems. These diagrams are generated from code,
      version-controlled, and automatically updated.
    </p>

    <!-- Architecture Philosophy -->
    <div
      class="border-electric-600/20 dark:border-electric-600/40 dark:to-slate-850 mb-16 rounded-lg border bg-gradient-to-br from-white to-gray-50 p-6 dark:from-slate-900"
    >
      <h2 class="mb-4 text-2xl font-bold">Why Architecture as Code?</h2>
      <div class="grid gap-6 text-gray-900 md:grid-cols-2 dark:text-gray-100">
        <div>
          <h3 class="text-accent mb-2 font-semibold">âœ“ Always Up to Date</h3>
          <p class="text-sm">
            Diagrams live in the codebase and update with every change. No more outdated
            PowerPoints.
          </p>
        </div>
        <div>
          <h3 class="text-accent mb-2 font-semibold">âœ“ Version Controlled</h3>
          <p class="text-sm">
            Track architecture evolution over time. See what changed, when, and why.
          </p>
        </div>
        <div>
          <h3 class="text-accent mb-2 font-semibold">âœ“ Review & Collaborate</h3>
          <p class="text-sm">
            Architecture changes go through pull requests just like code. Team visibility built-in.
          </p>
        </div>
        <div>
          <h3 class="text-accent mb-2 font-semibold">âœ“ Automated Publishing</h3>
          <p class="text-sm">
            Diagrams render automatically in CI/CD. Documentation deploys with every release.
          </p>
        </div>
      </div>
    </div>

    <!-- C4 Model Levels -->
    <section class="mb-16">
      <h2 class="mb-6 text-3xl font-bold">C4 Model: 4 Levels of Architecture Diagrams</h2>
      <p class="mb-6 text-gray-600 dark:text-slate-400">
        Progressive zoom from system context down to code level. Each level can be automatically
        generated from your infrastructure and application code.
      </p>

      <div class="grid gap-6 md:grid-cols-2">
        <!-- Level 1: System Context -->
        <div
          class="border-electric-600/20 dark:border-electric-600/40 rounded-lg border-2 bg-white p-6 dark:bg-slate-900"
        >
          <div class="mb-4 flex items-center justify-between">
            <h3 class="text-xl font-bold">Level 1: System Context</h3>
            <span class="badge-accent">System</span>
          </div>
          <p class="mb-4 text-sm text-gray-600 dark:text-slate-400">
            Big picture: your system, users, and external dependencies
          </p>
          <div class="mb-4 rounded bg-slate-100 p-3 font-mono text-xs dark:bg-slate-800/60">
            User â†’ Web App â†’ Database<br />
            Web App â†’ Payment API<br />
            Web App â†’ Email Service
          </div>
          <div class="space-y-2 text-sm">
            <div>
              <strong class="text-green-600 dark:text-green-400">âš¡ How It Works:</strong>
              <p class="mt-1 text-gray-600 dark:text-slate-400">
                Parse deployment pipelines and infrastructure configs to extract external systems
              </p>
            </div>
            <div class="border-electric-600/20 dark:border-electric-600/40 border-l-2 pl-4">
              <strong class="text-accent text-xs">Real Example:</strong>
              <p class="mt-1 text-xs text-gray-600 dark:text-slate-400">
                Parse <code class="rounded bg-gray-100 px-1 dark:bg-gray-700"
                  >.github/workflows/cd.yml</code
                > to extract Cloudflare Pages, deployment triggers, and external services
              </p>
            </div>
          </div>
        </div>

        <!-- Level 2: Container -->
        <div
          class="rounded-lg border-2 border-gray-300 bg-white p-6 dark:border-white/10 dark:bg-slate-900"
        >
          <div class="mb-4 flex items-center justify-between">
            <h3 class="text-xl font-bold">Level 2: Container</h3>
            <span
              class="rounded-full bg-gray-200 px-3 py-1 text-xs font-semibold text-gray-700 dark:bg-gray-800 dark:text-slate-300"
              >Container</span
            >
          </div>
          <p class="mb-4 text-sm text-gray-600 dark:text-slate-400">
            Applications, databases, microservices, file systems
          </p>
          <div class="mb-4 rounded bg-slate-100 p-3 font-mono text-xs dark:bg-slate-800/60">
            React SPA<br />
            Node.js API<br />
            Redis Cache<br />
            PostgreSQL DB
          </div>
          <div class="space-y-2 text-sm">
            <div>
              <strong class="text-green-600 dark:text-green-400">âš¡ How It Works:</strong>
              <p class="mt-1 text-gray-600 dark:text-slate-400">
                Parse Infrastructure as Code to extract resources and dependencies
              </p>
            </div>
            <div class="border-l-2 border-gray-300 pl-4 dark:border-gray-600">
              <strong class="text-xs text-gray-600 dark:text-slate-400">Real Example:</strong>
              <p class="mt-1 text-xs text-gray-600 dark:text-slate-400">
                <code class="rounded bg-gray-100 px-1 dark:bg-gray-700"
                  >inframap generate terraform/</code
                > generates PlantUML from Terraform state, or parse <code
                  class="rounded bg-gray-100 px-1 dark:bg-gray-700">package.json</code
                > dependencies
              </p>
            </div>
          </div>
        </div>

        <!-- Level 3: Component -->
        <div
          class="rounded-lg border-2 border-green-200 bg-white p-6 dark:border-green-800 dark:bg-slate-900"
        >
          <div class="mb-4 flex items-center justify-between">
            <h3 class="text-xl font-bold">Level 3: Component</h3>
            <span
              class="rounded-full bg-green-100 px-3 py-1 text-xs font-semibold text-green-700 dark:bg-green-900 dark:text-green-300"
              >Component</span
            >
          </div>
          <p class="mb-4 text-sm text-gray-600 dark:text-slate-400">
            Services, controllers, repositories within a container
          </p>
          <div class="mb-4 rounded bg-slate-100 p-3 font-mono text-xs dark:bg-slate-800/60">
            UserService<br />
            OrderController<br />
            PaymentGateway<br />
            DatabaseRepository
          </div>
          <div class="space-y-2 text-sm">
            <div>
              <strong class="text-green-600 dark:text-green-400">âš¡ How It Works:</strong>
              <p class="mt-1 text-gray-600 dark:text-slate-400">
                Scan source code directory structure and module organization
              </p>
            </div>
            <div class="border-l-2 border-green-200 pl-4 dark:border-green-700">
              <strong class="text-xs text-green-600 dark:text-green-400">Real Example:</strong>
              <p class="mt-1 text-xs text-gray-600 dark:text-slate-400">
                Recursively scan <code class="rounded bg-gray-100 px-1 dark:bg-gray-700"
                  >src/services/</code
                >, <code class="rounded bg-gray-100 px-1 dark:bg-gray-700">src/components/</code> directories
                and parse <code class="rounded bg-gray-100 px-1 dark:bg-gray-700">index.ts</code> exports
              </p>
            </div>
          </div>
        </div>

        <!-- Level 4: Code -->
        <div
          class="rounded-lg border-2 border-orange-200 bg-white p-6 dark:border-orange-800 dark:bg-slate-900"
        >
          <div class="mb-4 flex items-center justify-between">
            <h3 class="text-xl font-bold">Level 4: Code</h3>
            <span
              class="rounded-full bg-orange-100 px-3 py-1 text-xs font-semibold text-orange-700 dark:bg-orange-900 dark:text-orange-300"
              >Code</span
            >
          </div>
          <p class="mb-4 text-sm text-gray-600 dark:text-slate-400">
            Classes, methods, functions, interfaces
          </p>
          <div class="mb-4 rounded bg-slate-100 p-3 font-mono text-xs dark:bg-slate-800/60">
            class UserService {'{'}<br />
            &nbsp;&nbsp;getUser(id)<br />
            &nbsp;&nbsp;updateUser(id, data)<br />
            &nbsp;&nbsp;deleteUser(id)<br />
            {'}'}
          </div>
          <div class="space-y-2 text-sm">
            <div>
              <strong class="text-green-600 dark:text-green-400">âš¡ How It Works:</strong>
              <p class="mt-1 text-gray-600 dark:text-slate-400">
                Use AST parsers to extract class structures, method signatures, and dependencies
              </p>
            </div>
            <div class="border-l-2 border-orange-200 pl-4 dark:border-orange-700">
              <strong class="text-xs text-orange-600 dark:text-orange-400">Real Example:</strong>
              <p class="mt-1 text-xs text-gray-600 dark:text-slate-400">
                Use <code class="rounded bg-gray-100 px-1 dark:bg-gray-700">acorn</code> or <code
                  class="rounded bg-gray-100 px-1 dark:bg-gray-700">@babel/parser</code
                > to parse TypeScript files and extract class methods, or use <code
                  class="rounded bg-gray-100 px-1 dark:bg-gray-700">typedoc</code
                > for full API docs
              </p>
            </div>
          </div>
        </div>
      </div>

      <div
        class="border-electric-600/20 dark:border-electric-600/40 bg-electric-600/10 mt-6 rounded border p-4 dark:bg-slate-800/60"
      >
        <p class="text-sm text-gray-700 dark:text-slate-300">
          <strong>ðŸ’¡ This Portfolio:</strong> All 4 C4 levels are auto-generated from code using
          <code class="rounded bg-white px-2 py-1 text-xs dark:bg-slate-900">npm run docs:arch</code
          >
        </p>
      </div>
    </section>

    <!-- Example 1: C4 Level 1 - System Context -->
    <section class="mb-16">
      <h2 class="mb-6 text-3xl font-bold">
        <span class="badge-accent mr-2 text-sm font-semibold">Level 1</span>
        System Context Example
      </h2>
      <p class="mb-6 text-gray-600 dark:text-slate-400">
        High-level view of this portfolio site and its external dependencies, auto-generated from
        GitHub Actions workflows.
      </p>

      <div
        class="rounded-lg border border-gray-200 bg-white p-6 dark:border-white/5 dark:bg-slate-900"
      >
        <div class="mermaid-diagram mb-4">
          <pre
            class="mermaid overflow-x-auto rounded bg-white p-4 dark:bg-slate-900">{`graph TB
    User[Visitor]
    Site[ChrisLyons.dev<br/>Portfolio Site]
    CF[Cloudflare Pages<br/>Hosting + CDN]
    GH[GitHub<br/>Source & CI/CD]
    LH[Lighthouse CI<br/>Performance Testing]
    GP[GitHub Pages<br/>Documentation]

    User -->|Views| Site
    Site -->|Deployed to| CF
    GH -->|Builds & Deploys| CF
    GH -->|Runs tests| LH
    GH -->|Publishes docs| GP
    LH -->|Uploads reports| CF

    style Site fill:#2563eb,color:#fff
    style User fill:#7c3aed,color:#fff
    style CF fill:#f97316,color:#fff
    style GH fill:#059669,color:#fff`}</pre>
        </div>
        <div class="text-sm text-gray-600 dark:text-slate-400">
          <strong>Generated from:</strong>
          <code class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800"
            >.github/workflows/cd.yml</code
          > and <code class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800">ci.yml</code>
        </div>
      </div>
    </section>

    <!-- Example 2: C4 Level 2 - Microservices -->
    <section class="mb-16">
      <h2 class="mb-6 text-3xl font-bold">
        <span
          class="mr-2 rounded bg-gray-200 px-3 py-1 text-sm font-semibold text-gray-700 dark:bg-gray-800 dark:text-slate-300"
          >Level 2</span
        >
        Container Example: Microservices Architecture
      </h2>
      <p class="mb-6 text-gray-600 dark:text-slate-400">
        Event-driven microservices with Kafka showing containers (services, databases, message
        queues) and their interactions.
      </p>

      <div
        class="rounded-lg border border-gray-200 bg-white p-6 dark:border-white/5 dark:bg-slate-900"
      >
        <div class="mermaid-diagram mb-4">
          <pre
            class="mermaid overflow-x-auto rounded bg-white p-4 dark:bg-slate-900">{microservicesDiagram}</pre>
        </div>
        <div class="text-sm text-gray-600 dark:text-slate-400">
          <strong>Source:</strong>
          <code class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800"
            >docs/architecture/examples/microservices.mmd</code
          >
        </div>
      </div>
    </section>

    <!-- Example 3: C4 Level 2 - Data Pipeline -->
    <section class="mb-16">
      <h2 class="mb-6 text-3xl font-bold">
        <span
          class="mr-2 rounded bg-gray-200 px-3 py-1 text-sm font-semibold text-gray-700 dark:bg-gray-800 dark:text-slate-300"
          >Level 2</span
        >
        Container Example: Data Pipeline Architecture
      </h2>
      <p class="mb-6 text-gray-600 dark:text-slate-400">
        Real-time and batch data processing containers showing data flow from ingestion through
        transformation to consumption.
      </p>

      <div
        class="rounded-lg border border-gray-200 bg-white p-6 dark:border-white/5 dark:bg-slate-900"
      >
        <div class="mermaid-diagram mb-4">
          <pre
            class="mermaid overflow-x-auto rounded bg-white p-4 dark:bg-slate-900">{dataPipelineDiagram}</pre>
        </div>
        <div class="text-sm text-gray-600 dark:text-slate-400">
          <strong>Source:</strong>
          <code class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800"
            >docs/architecture/examples/data-pipeline.mmd</code
          >
        </div>
      </div>
    </section>

    <!-- Example 4: C4 Level 3 - Components -->
    <section class="mb-16">
      <h2 class="mb-6 text-3xl font-bold">
        <span
          class="mr-2 rounded bg-green-100 px-3 py-1 text-sm font-semibold text-green-700 dark:bg-green-900 dark:text-green-300"
          >Level 3</span
        >
        Component Example: Order Service
      </h2>
      <p class="mb-6 text-gray-600 dark:text-slate-400">
        Zooming into the Order Service container to show its internal components, controllers, and
        repositories.
      </p>

      <PlantUMLDiagram
        code={orderServiceDiagram}
        alt="C4 Component Diagram - Order Service"
        client:visible
      />

      <div class="mt-6 rounded-lg bg-gray-50 p-4 dark:bg-gray-800">
        <details class="cursor-pointer">
          <summary class="mb-2 text-sm font-semibold">View PlantUML Source Code</summary>
          <pre
            class="mt-2 overflow-x-auto rounded bg-white p-3 text-xs dark:bg-slate-900"><code>{orderServiceDiagram}</code></pre>
        </details>
        <div class="mt-3 text-sm text-gray-600 dark:text-slate-400">
          <strong>Source:</strong>
          <code class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800"
            >docs/architecture/examples/order-service.puml</code
          >
        </div>
      </div>
    </section>

    <!-- Example 5: C4 Level 4 - Code -->
    <section class="mb-16">
      <h2 class="mb-6 text-3xl font-bold">
        <span
          class="mr-2 rounded bg-orange-100 px-3 py-1 text-sm font-semibold text-orange-700 dark:bg-orange-900 dark:text-orange-300"
          >Level 4</span
        >
        Code Example: ThemeManager Class
      </h2>
      <p class="mb-6 text-gray-600 dark:text-slate-400">
        Zooming into a component to show class structure and method signatures, auto-generated from
        TypeScript source code.
        <strong>Note:</strong> Level 4 diagrams are optional. They're great for critical algorithms,
        security components, or complex business logic that needs detailed documentation. But avoid generating
        them for entire systemsâ€”they quickly become overwhelming and unmaintainable at scale.
      </p>

      <div
        class="rounded-lg border border-gray-200 bg-white p-6 dark:border-white/5 dark:bg-slate-900"
      >
        <div class="mermaid-diagram mb-4">
          <pre
            class="mermaid overflow-x-auto rounded bg-white p-4 dark:bg-slate-900">{`classDiagram
    class ThemeManager {
        -storage: ThemeStorage
        -favicon: FaviconManager
        +getThemePreference() Theme
        +applyTheme(theme: Theme) void
        +setTheme(theme: Theme) void
        +initializeTheme() void
        +toggleTheme() void
    }

    class ThemeStorage {
        +get() Theme
        +set(theme: Theme) void
    }

    class FaviconManager {
        +update(theme: Theme) void
    }

    ThemeManager --> ThemeStorage : uses
    ThemeManager --> FaviconManager : uses

    note "Auto-generated from src/services/ThemeManager.ts"`}</pre>
        </div>
        <div class="text-sm text-gray-600 dark:text-slate-400">
          <strong>Generated from:</strong>
          <code class="rounded bg-gray-100 px-2 py-1 dark:bg-gray-800"
            >src/services/ThemeManager.ts</code
          > using AST parsing
        </div>
      </div>
    </section>

    <!-- Call to Action -->
    <div
      class="rounded-lg border border-gray-200 bg-gray-50 p-8 text-center dark:border-white/5 dark:bg-slate-900/50"
    >
      <h2 class="mb-4 text-2xl font-bold">Want to See More?</h2>
      <p class="mb-6 text-gray-600 dark:text-slate-400">
        I can help you implement architecture as code practices in your organization. From tooling
        setup to CI/CD integration and team training.
      </p>
      <a href="/contact" class="btn-primary inline-block"> Let's Talk Architecture </a>
    </div>
  </div>

  <script type="module" src={architectureMermaidUrl}></script>
</Layout>
