# Security Notes for chrislyons.dev

This document explains the security choices for this site, mainly around
Content Security Policy (CSP) and how it behaves with Cloudflare.

---

## What is Content Security Policy (CSP)?

CSP tells browsers which scripts, styles, and resources are safe to load. Think of it
as a bouncer that checks IDs — only pre-approved code gets in. This blocks XSS attacks
by stopping malicious scripts from running, even if they slip into your HTML.

The goal is **simple and strict**:

- Only run JavaScript we control.
- Keep browser rules predictable.
- Accept a bit of noise from Cloudflare rather than weaken the policy.

## Why We Did This

The site started with a simple color scheme rebrand. While updating styles, we noticed
inline scripts weren't following best practices. This led us down a CSP hardening path
to eliminate XSS risks entirely.

Trade-off: We accept that some Cloudflare edge scripts get blocked rather than weaken
our policy. Core functionality is unaffected.

---

## Content Security Policy (CSP)

We set a CSP header via the `_headers` file in the built `dist/` folder.

Key points:

- **default-src 'self'**  
  All resources (unless overridden) must come from our own origin.

- **script-src 'self' https://static.cloudflareinsights.com ...hashes...**
  - JS is only allowed from:
    - our own origin (`'self'`)
    - Cloudflare’s analytics endpoint
  - Inline scripts are **not allowed by default**.  
    Only specific inline snippets are allowed, using SHA-256 hashes
    generated at build time.

- **No `unsafe-inline` for scripts**  
  We deliberately do **not** allow arbitrary inline JavaScript.  
  This reduces the risk of XSS and makes it harder for injected code to run.

- **Styles are looser**  
  We currently allow `style-src 'self' 'unsafe-inline'` because of
  framework and Tailwind usage. This is a reasonable trade-off for this site.

---

## JavaScript layout

To keep the CSP simple and stable:

- **Navigation / mobile menu behavior** lives in a separate JS module:
  - Example: `/_astro/nav.<hash>.js`
  - Loaded with `<script type="module" src="/_astro/nav..."></script>`.

- **Mermaid diagram rendering** also uses separate modules:
  - `/_astro/projects-mermaid.<hash>.js` (lazy-loaded on projects page)
  - `/_astro/architecture-mermaid.<hash>.js` (lazy-loaded on architecture page)
  - Uses IntersectionObserver for viewport-based loading

- These work with `'self'` in `script-src` and need no hash or nonce.

- A few small inline scripts are still needed (theme init, Astro runtime bits).
  These are allowed via **explicit CSP hashes** generated by a build script.

---

## Cloudflare Behavior and CSP Warnings

### What Cloudflare Injects

Cloudflare may inject its own **inline script** for bot protection or JS challenges:

```html
<script>
  (function () {
    // Creates a hidden iframe and injects a script that hits /cdn-cgi/...
    // Includes dynamic tokens (r: '...', t: '...')
  })();
</script>
```

### Why It Gets Blocked

- Script is **not in our source** — added by Cloudflare at the edge
- Contents **change per request** — cannot pre-compute a CSP hash
- It has **no nonce** — cannot allowlist dynamically

### This is Intentional

Our CSP **blocks this inline script**. Browser console shows:

> Executing inline script violates the following Content Security Policy directive…

**This is expected.** We prefer strict CSP over allowing dynamic Cloudflare injections.
Core site features (navigation, content, theme toggle) still work as designed.

### Future Options

If needed, we can:

- Try to tune Cloudflare settings to reduce or remove these injections, or
- Loosen CSP on specific paths, but that's not required today.

---

## Lighthouse suggestions

Lighthouse may show a few security suggestions:

- **“Add Trusted Types directive”**  
  This is an extra hardening step against XSS.  
  It’s useful for large, dynamic apps, but is **not necessary** for this
  mostly static personal site right now.

- **“Host allowlists can be bypassed; use nonces/hashes and 'strict-dynamic'”**  
  We already use hashes for inline scripts and only allow JS from `'self'`
  - Cloudflare Insights.  
    If we ever move to heavy SSR and lots of dynamic JS, we can revisit
    a nonce-based policy with `'strict-dynamic'`.

- **“Consider adding 'unsafe-inline' for backwards compatibility”**  
  We **intentionally do not** add `unsafe-inline` for scripts.
  Older browsers are not a priority for this site, and security wins here.

---

## Future improvements (if needed)

If the site grows more complex or moves to SSR, possible next steps are:

- Switch to a **nonce-based CSP** for inline scripts (`script-src 'self' 'nonce-...' 'strict-dynamic'`).
- Add a **Trusted Types** policy if we start doing dynamic HTML string work.
- Tighten `style-src` once the CSS pipeline is more stable.

For the current scope (personal site, static Astro build), the existing setup
is a good balance of safety, simplicity, and practicality.

---

## Local Development Notes

The site uses Astro's `experimental.clientPrerender` feature for improved client-side
routing. This affects local CSP testing:

- **Local builds** generate `.mjs` files instead of `.html` files
- The `generate-csp-headers.mjs` script requires static HTML files to parse
- **Production builds** on Cloudflare Pages work correctly

### Testing CSP Locally

**Option 1: Disable clientPrerender temporarily**

```javascript
// astro.config.mjs
// experimental: {
//   clientPrerender: true,
// },
```

Then run:

```bash
npm run build && node scripts/generate-csp-headers.mjs
```

Check `dist/_headers` for generated CSP, then re-enable `clientPrerender` before committing.

**Option 2: Test via preview server**

```bash
npm run build
npm run preview
```

The preview server serves HTML dynamically, so you can inspect CSP headers in the browser's
Network tab (though `_headers` won't be generated locally).
